name: Deploy Partisia Indexer

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        type: choice
        options: [production, development]

      server:
        description: 'Server'
        required: true
        type: choice
        options: [helhetz01, helhetz02]

      reset_db:
        description: 'Database reset mode'
        required: false
        default: 'none'
        type: choice
        options: ['none', 'protocol', 'all']

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set environment
        run: |
          echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          echo "RESET_DB=${{ github.event.inputs.reset_db }}" >> $GITHUB_ENV

          if [[ "${{ github.event.inputs.server }}" == "helhetz01" ]]; then
            echo "SERVER_HOST=helhetz01.romenet.io" >> $GITHUB_ENV
            echo "PORTS_PREFIX=${{ github.event.inputs.environment == 'production' && '17' || '27' }}" >> $GITHUB_ENV
            echo "SSH_KEY_SECRET=SSH_PRIVATE_KEY_HELHETZ01" >> $GITHUB_ENV
          else
            echo "SERVER_HOST=helhetz02.romenet.io" >> $GITHUB_ENV
            echo "PORTS_PREFIX=${{ github.event.inputs.environment == 'production' && '18' || '28' }}" >> $GITHUB_ENV
            echo "SSH_KEY_SECRET=SSH_PRIVATE_KEY_HELHETZ02" >> $GITHUB_ENV
          fi

          echo "PROJECT_NAME=partisia-indexer-${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          echo "DEPLOY_PATH=/home/partisia/partisia-indexer-${{ github.event.inputs.environment }}" >> $GITHUB_ENV

      - uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ github.event.inputs.server == 'helhetz01' && secrets.SSH_PRIVATE_KEY_HELHETZ01 || secrets.SSH_PRIVATE_KEY_HELHETZ02 }}

      - name: Create docker-compose
        run: |
          cat > docker-compose.${{ env.ENVIRONMENT }}.yaml << 'COMPOSE_EOF'
          name: ${{ env.PROJECT_NAME }}
          services:
            postgres:
              image: postgres:16.5
              restart: always
              environment:
                POSTGRES_PASSWORD: letmein
                POSTGRES_USER: indexer
                POSTGRES_DB: ls_indexer
              volumes:
                - pgdata_${{ env.ENVIRONMENT }}:/var/lib/postgresql/data
                - ./src/db/schema_sparse.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
              ports:
                - '${{ env.PORTS_PREFIX }}432:5432'
              networks:
                - partisia_net

            indexer:
              build: .
              restart: always
              depends_on:
                - postgres
              environment:
                - NODE_ENV=production
                - API_PORT=3002
                - PARTISIA_API_URL=http://95.216.235.72:18080
                - LS_CONTRACT=02fc82abf81cbb36acfe196faa1ad49ddfa7abdda6
                - PARTISIA_SHARD=Shard2
                - DEPLOYMENT_BLOCK=10682802
                - DB_HOST=postgres
                - DB_PORT=5432
                - DB_NAME=ls_indexer
                - DB_USER=indexer
                - DB_PASSWORD=letmein
                - DB_SSL=false
                - BATCH_SIZE=1000
                - CONCURRENCY=100
                - INDEXER_BATCH_SIZE=1000
                - INDEXER_CONCURRENCY=100
                - INDEX_INTERVAL_S=10
                - MAX_RETRIES=3
                - MEXC_SYMBOL=MPCUSDT
                - MEXC_POLL_INTERVAL=10
                - COINGECKO_API_KEY=${{ secrets.COINGECKO_API_KEY || 'CG-WHeHa5zx8cdGLqhAvbzDTZXh' }}
                - ENABLE_TX_INDEXER=true
                - TX_BATCH_SIZE=10
                - TX_CONCURRENCY=2
                - TX_RETRY_ATTEMPTS=3
                - USE_PUBLIC_API_FOR_BLOCKS=true
                - TEMP_PUBLIC_API_FOR_BLOCKS=https://reader.partisiablockchain.com
                - STAKING_RESPONSIBLE=000016e01e04096e52e0a6021e877f01760552abfb
                - ADMIN_ACCOUNT=000016e01e04096e52e0a6021e877f01760552abfb
              ports:
                - '${{ env.PORTS_PREFIX }}942:3002'
              networks:
                - partisia_net

          networks:
            partisia_net:
              name: partisia_net_${{ env.ENVIRONMENT }}

          volumes:
            pgdata_${{ env.ENVIRONMENT }}:
          COMPOSE_EOF

      - name: Deploy
        run: |
          set -e
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          ssh partisia@${{ env.SERVER_HOST }} "mkdir -p ${{ env.DEPLOY_PATH }}/src/db"

          tar -czf deploy.tar.gz src scripts package.json tsconfig.json Dockerfile bun.lock docker-compose.${{ env.ENVIRONMENT }}.yaml example-graph
          scp deploy.tar.gz partisia@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/

          ssh partisia@${{ env.SERVER_HOST }} << EOF
            set -e
            cd ${{ env.DEPLOY_PATH }}
            tar -xzf deploy.tar.gz
            rm deploy.tar.gz

            # Database schema is auto-initialized by Docker Compose via docker-entrypoint-initdb.d/
            echo "ðŸ—ƒï¸ Database schema will be initialized automatically on first run"

            # Reset database tables based on mode
            if [[ "${RESET_DB}" == "protocol" ]]; then
              echo "âš ï¸ Resetting protocol tables for resync (keeping prices)"
              docker exec -i \$(docker compose -f docker-compose.${{ env.ENVIRONMENT }}.yaml ps -q postgres) \
                psql -U indexer -d ls_indexer <<SQL
          TRUNCATE contract_states RESTART IDENTITY CASCADE;
          TRUNCATE current_state RESTART IDENTITY CASCADE;
          TRUNCATE transactions RESTART IDENTITY CASCADE;
          TRUNCATE protocol_rewards RESTART IDENTITY CASCADE;
          TRUNCATE users RESTART IDENTITY CASCADE;
          SQL
            elif [[ "${RESET_DB}" == "all" ]]; then
              echo "ðŸ’¥ Flushing ALL database tables (complete reset)"
              docker exec -i \$(docker compose -f docker-compose.${{ env.ENVIRONMENT }}.yaml ps -q postgres) \
                psql -U indexer -d ls_indexer <<SQL
          TRUNCATE contract_states RESTART IDENTITY CASCADE;
          TRUNCATE current_state RESTART IDENTITY CASCADE;
          TRUNCATE transactions RESTART IDENTITY CASCADE;
          TRUNCATE protocol_rewards RESTART IDENTITY CASCADE;
          TRUNCATE users RESTART IDENTITY CASCADE;
          TRUNCATE price_history RESTART IDENTITY CASCADE;
          TRUNCATE mpc_prices RESTART IDENTITY CASCADE;
          SQL
            fi

            # Stop only indexer, keep postgres running
            docker compose -f docker-compose.${{ env.ENVIRONMENT }}.yaml stop indexer 2>/dev/null || true
            docker compose -f docker-compose.${{ env.ENVIRONMENT }}.yaml rm -f indexer 2>/dev/null || true

            # Rebuild and start indexer
            docker compose -f docker-compose.${{ env.ENVIRONMENT }}.yaml build --no-cache indexer
            docker compose -f docker-compose.${{ env.ENVIRONMENT }}.yaml up -d

            sleep 10
            docker compose -f docker-compose.${{ env.ENVIRONMENT }}.yaml ps

            if ! curl -sf http://localhost:${{ env.PORTS_PREFIX }}942/health > /dev/null; then
              echo "Health check failed"
              docker compose -f docker-compose.${{ env.ENVIRONMENT }}.yaml logs indexer --tail=50
              exit 1
            fi

            echo "âœ… Deployment successful"
          EOF

      - name: Verify deployment
        run: |
          sleep 5
          curl -sf http://${{ env.SERVER_HOST }}:${{ env.PORTS_PREFIX }}942/health || exit 1
          curl -sf http://${{ env.SERVER_HOST }}:${{ env.PORTS_PREFIX }}942/api || exit 1

      - name: Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY_EOF'
          ### Deployment Summary
          - **Server**: ${{ env.SERVER_HOST }}
          - **Environment**: ${{ env.ENVIRONMENT }}
          - **API**: http://${{ env.SERVER_HOST }}:${{ env.PORTS_PREFIX }}942
          - **GraphQL**: http://${{ env.SERVER_HOST }}:${{ env.PORTS_PREFIX }}942/graphql
          - **PostgreSQL**: ${{ env.SERVER_HOST }}:${{ env.PORTS_PREFIX }}432

          ### Test endpoints
          ```bash
          curl http://${{ env.SERVER_HOST }}:${{ env.PORTS_PREFIX }}942/health
          curl http://${{ env.SERVER_HOST }}:${{ env.PORTS_PREFIX }}942/stats
          ```
          SUMMARY_EOF
